<div class="chat-app">
    <div class="conversations-panel">
        <div class="loading-state" *ngIf="isLoading; else noLoadingTemplate">
            <i class="pi pi-spin pi-spinner"></i> Loading...
        </div>
        <ng-template #noLoadingTemplate>
            <ul class="conversation-list" >
                <li *ngFor="let item of contactedEmployees">
                    <button (click)="chooseConversation(item?.id)" [class]="selectedChatUser?.id==item?.id?'conversation-card selected':'conversation-card'">
                        <p-avatar label="{{getInitials(item?.first_name, item?.last_name)}}" shape="circle" styleClass="mr-2"></p-avatar>
                        <span style="font-weight: bold; color: #495057;">{{item?.first_name}} {{item?.last_name}}</span>
                    </button>
                </li>
                <li>

                </li>
                <li>
                    <p-button
              icon="pi pi-plus"
              label="Start New Chat"
              styleClass="add-conversation-btn"
              [raised]="true"
              severity="primary"
              (onClick)="openDialog()">
          </p-button>
                </li>
            </ul>
          </ng-template>

    </div>

    <div class="chat-panel">
        <div class="empty-chat" *ngIf="!selectedChatUser else chatBoxTemplate">
            <p-divider align="center">
                <b>Select a conversation to start chatting</b>
            </p-divider>
        </div>
        <ng-template #chatBoxTemplate>
            <div class="chat-header">
                        <p-avatar label="{{getInitials(selectedChatUser?.first_name, selectedChatUser?.last_name)}}" shape="circle" styleClass="mr-2"></p-avatar>
                <div class="chat-header-info">
                  <div class="flex align-items-start gap-2">
                    <h3 class="m-0">{{selectedChatUser?.first_name}} {{selectedChatUser?.last_name}}</h3>
                    <p-badge [value]="unReadMessages.length" *ngIf="unReadMessages.length" severity="success" styleClass="ml-2"></p-badge>
                </div>
                <span>
                    <p-tag [value]="selectedChatUser?.job_title?.toString() || 'Missing'" severity="secondary" rounded="true"></p-tag>
                  </span>
                  </div>
            </div>

            <div class="chat-messages-container">
                <p-scrollPanel class="chat-messages" #messagesPanel>
                    <div class="messages-timeline">
                        <div *ngFor="let item of actualConversationMessages; let i = index"
                             class="message-wrapper"
                             [ngClass]="{'own-message': item.sender.id == id, 'other-message': item.sender.id != id}">

                            <div class="message-bubble"
                                 [ngClass]="{'sent': item.sender.id == id, 'received': item.sender.id != id}">

                                <div class="message-avatar" *ngIf="item.sender.id != id">
                                    <p-avatar
                                        [label]="getInitials(item.sender.first_name, item.sender.last_name)"
                                        shape="circle"
                                        [style]="{'background-color': getAvatarColor(item.sender.id), 'color': 'white'}">
                                    </p-avatar>
                                </div>

                                <div class="message-content">
                                    <div class="message-header" *ngIf="item.sender.id != id">
                                        <span class="sender-name">{{item.sender.first_name}} {{item.sender.last_name}}</span>
                                    </div>

                                    <div class="message-text">
                                        {{item.message}}
                                    </div>

                                    <div class="message-footer">
                                        <span class="message-time">{{item.created_at}}</span>
                                        <i class="pi pi-check message-status" *ngIf="item.sender.id == id"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unread Messages Divider -->
                    <div class="unread-divider" *ngIf="unReadMessages.length > 0">
                        <div class="divider-line"></div>
                        <span class="divider-text">
                            <i class="pi pi-circle-fill unread-indicator"></i>
                            {{unReadMessages.length}} unread message{{unReadMessages.length > 1 ? 's' : ''}}
                        </span>
                        <div class="divider-line"></div>
                    </div>

                    <div class="messages-timeline unread-section">
                        <div *ngFor="let item of unReadMessages; let i = index"
                             class="message-wrapper unread-message"
                             [ngClass]="{'own-message': item.sender.id == id, 'other-message': item.sender.id != id}">

                            <div class="message-bubble"
                                 [ngClass]="{'sent': item.sender.id == id, 'received': item.sender.id != id}">

                                <div class="message-avatar" *ngIf="item.sender.id != id">
                                    <p-avatar
                                        [label]="getInitials(item.sender.first_name, item.sender.last_name)"
                                        shape="circle"
                                        [style]="{'background-color': getAvatarColor(item.sender.id), 'color': 'white'}">
                                    </p-avatar>
                                </div>

                                <div class="message-content">
                                    <div class="message-header" *ngIf="item.sender.id != id">
                                        <span class="sender-name">{{item.sender.first_name}} {{item.sender.last_name}}</span>
                                    </div>

                                    <div class="message-text">
                                        {{item.message}}
                                    </div>

                                    <div class="message-footer">
                                        <span class="message-time">{{formatTime(item.created_at)}}</span>
                                        <i class="pi pi-check message-status" *ngIf="item.sender.id == id"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </p-scrollPanel>
            </div>

            <div class="chat-input-group">
                <input type="text" pInputText [(ngModel)]="message" autoResize="true" class="chat-input" placeholder="Type a message..."/>
                <p-button icon="pi pi-send" [loading]="isSendingMessageLoading" (onClick)="sendMessage(message)" styleClass="send-message-btn"></p-button>
            </div>
        </ng-template>
    </div>

    <!-- Chat Modal -->
    <app-chat-modal (closeM)="closeModal($event)" [visible]="isModalOpen" (contactSelected)="chooseConversation($event.id)"></app-chat-modal>
</div>
